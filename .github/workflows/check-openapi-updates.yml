name: Check OpenAPI Schema Updates

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

jobs:
  check-updates:
    name: Check for GitHub OpenAPI schema updates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Generate types from latest schema
        run: make generate

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet internal/githubopenapi/types.gen.go; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "## Changes detected in generated types" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff internal/githubopenapi/types.gen.go >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create or update issue
        if: steps.diff.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”„ GitHub OpenAPI schema has been updated';
            const labels = ['dependencies', 'automated'];

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labels.join(','),
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            const body = `## GitHub OpenAPI Schema Update Detected

            The GitHub OpenAPI schema has been updated and the generated types have changed.

            ### Action Required
            1. Run \`make generate\` locally to regenerate the types
            2. Review the changes and update any affected code
            3. Run tests to ensure everything works correctly
            4. Create a PR with the updated types

            ### Commands
            \`\`\`bash
            make generate
            go test ./...
            \`\`\`

            ---
            ðŸ¤– This issue was automatically created by the [Check OpenAPI Updates](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.
            `;

            if (existingIssue) {
              // Update existing issue with a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Schema changes detected again on ${new Date().toISOString().split('T')[0]}.\n\nSee [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`,
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels,
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }
